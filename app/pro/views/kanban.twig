{% extends "template/base.twig" %}

{% block title %}Pro{% endblock %}

{% block content %}
    <div uk-grid style="height:100%;">
        <div class="uk-width-4-5">
            <a href="#add" class="uk-button uk-button-primary">Add Task</a>
            <div uk-grid class="uk-child-width-expand" style="min-height: 80%;">

                {% for k, v in kanban %}
                    <div>
                        <p><i class="icofont icofont-{{ v.icon }}"></i> {{ k }}</p>
                        <div class="droppable" data-type="backlog">
                            {% for l in v.list %}
                                <div id="task_{{ l.id }}" class="item draggable" data-id="{{ l.id }}">
                                    <span style="color:{{ l.organisation_color }}; float:right">{{ l.organisation_name }}</span>
                                    {{ l.title }}
                                    {% if l.nb_subtask %}
                                        <progress class="uk-progress" value="{{ l.nb_finished }}" max="{{ l.nb_subtask }}"></progress>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="uk-width-1-5 uk-padding" id="result"></div>
    </div>


    <style>
        .droppable {
            border:dashed 1px #adadad;
            min-height:80%;
        }

        .item {
            border-radius: 3px;
            margin:5px; padding:5px;
            background-color: white;
            border:solid 1px #646464;
        }

        .item.active {
            border-color:#1e87f0;
        }

        .item:hover {
            cursor:move;
            cursor: grab;
        }

        .item.ui-draggable-dragging {
            cursor: grabbing;
            box-shadow: 9px 9px 3px rgba(150,150,150, .5);
        }
    </style>
{% endblock %}

{% block script %}
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <script>
        $(document).ready(function() {
            $(".draggable").draggable({});
            $(".droppable").droppable({
                drop: function (event, ui) {
                    console.log(this);
                    console.log(event);
                }
            });
        });

        $('div.item').on('click', function() {
            var id = $(this).data("id");
            refreshTask(id);
        });

        var refreshTask = function(id) {
            $.ajax({
                url: '{{ prefix }}/pro/task/'+id,
                method : 'get',
                beforeSend : function() {
                    $('#result').html('loading');
                    $('.item').removeClass('active');
                },
                success: function(data) {
                    $('#result').html(data);
                }
            });
        };

        var updateTask = function(form) {
            var id = $(form).data("id");
            $.ajax({
                url: '{{ prefix }}/pro/task/edit',
                method: 'post',
                data: $(form).serialize(),
                success: function(data) {
                    refreshTask(id);
                }

            });
            return false;
        };
    </script>
{% endblock %}